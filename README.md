# Excel to csv 技術ドキュメント

## 1. プロジェクト概要

### 1.1 プロジェクトの目的と用途
このプロジェクトは、Excelファイルを解析してCSV形式のデータに変換するツールを提供することを目的としています。具体的には、ユーザーがExcelファイルをアプリケーションにドロップすることで、その内容を解析し、CSV形式のテキストデータとして取得できるようにします。これにより、Excelデータを他のシステムやアプリケーションで利用する際のデータ変換を効率化します。このドキュメントは、新規参加者や既存ユーザがプロジェクトを理解し、円滑に開発に貢献できるよう、詳細な情報を提供します。

### 1.2 対象読者
- 新規開発者: プロジェクトの構造と技術を理解し、開発に参加する。
- 既存開発者: プロジェクトの技術的な詳細を再確認し、効率的な開発を行う。
- 非技術者: プロジェクトの概要と使い方を理解し、サービスの利用を開始する。

## 2. まず利用するために (Getting Started)

### 2.1 導入手順
非技術者向けに、プロジェクトを始めるための手順をステップバイステップで記述

1.  アプリケーションを起動します。
2.  ウィンドウにExcelファイルをドロップします。
3.  解析が完了すると、画面にCSV形式のテキストデータが表示されます。
4.  「ファイルに保存」ボタンを押すと、結果が `result.csv` という名前でローカルに保存されます。

### 2.2 初期設定のヒント
-   特に設定は必要ありません。アプリケーションを起動すればすぐに利用できます。
-   ドロップするファイルは `.xlsx` 形式のExcelファイルである必要があります。
-   変換されるCSVデータはUTF-8エンコーディングです。

## 3. ファイル構造図とディレクトリ説明

### 3.1 ファイル構造図 (ツリービュー)

```
excel-to-csv/
├── index.html
├── package-lock.json
├── package.json
├── README.md
├── src/
│   ├── App.css
│   ├── App.tsx
│   ├── components/
│   │   ├── drug.tsx
│   │   └── get_string.tsx
│   ├── main.tsx
│   └── vite-env.d.ts
├── src-tauri/
│   ├── build.rs
│   ├── capabilities/
│   │   └── default.json
│   ├── Cargo.toml
│   ├── public/
│   │   └── prompt.txt
│   ├── src/
│   │   ├── documents/
│   │   │   ├── docx.rs
│   │   │   ├── mod.rs
│   │   │   ├── request.rs
│   │   │   └── scan.rs
│   │   ├── lib.rs
│   │   └── main.rs
│   └── tauri.conf.json
├── tsconfig.json
├── tsconfig.node.json
└── vite.config.ts
```

### 3.2 ディレクトリとファイルの役割詳細

-   **`index.html`**: アプリケーションのエントリーポイントとなるHTMLファイルです。
-   **`package-lock.json`**, **`package.json`**: Node.jsのパッケージ管理に使用するファイルです。
-   **`README.md`**: プロジェクトの概要や説明を記述するファイルです。
-   **`src/`**: アプリケーションのソースコードが含まれるディレクトリです。
    -   **`App.css`**: アプリケーションのスタイル定義を行うCSSファイルです。
    -   **`App.tsx`**: アプリケーションのメインコンポーネントを含むTypeScriptファイルです。
    -   **`components/`**: 再利用可能なUIコンポーネントが含まれるディレクトリです。
        -   **`drug.tsx`**: ファイルドロップ機能と、Excelファイルの変換処理を行うメインのコンポーネントです。
        -   **`get_string.tsx`**: サンプルとして文字列入力をRust側に送信するコンポーネントです（現在は使用されていません）。
    -   **`main.tsx`**: Reactアプリケーションのエントリーポイントとなるファイルです。
    -   **`vite-env.d.ts`**: TypeScriptの型定義ファイルです。
-   **`src-tauri/`**: Tauriアプリケーションのバックエンドコードを含むディレクトリです。
    -   **`build.rs`**: Tauriアプリケーションのビルド設定ファイルです。
    -   **`capabilities/`**: Tauriの権限設定ファイルが含まれるディレクトリです。
        -   **`default.json`**: アプリケーションのデフォルトの権限設定を定義します。
    -   **`Cargo.toml`**: Rustのパッケージ管理に使用するファイルです。
    -   **`public/`**: アプリケーションで使用する静的ファイルが含まれるディレクトリです。
        -   **`prompt.txt`**: AI解析で使用するプロンプトテキストです（現在は使用されていません）。
    -   **`src/`**: Rustのソースコードが含まれるディレクトリです。
        -   **`documents/`**: ドキュメント解析に関するコードが含まれるディレクトリです。
            -   **`docx.rs`**: DOCXファイルからテキストを抽出するコードが含まれます。
            -   **`mod.rs`**: `documents` モジュールの定義ファイルです。
            -   **`request.rs`**: Gemini APIのリクエストを送信するコードです（現在は使用されていません）。
            -   **`scan.rs`**: ファイルをスキャンして情報を抽出するコードです（現在は使用されていません）。
        -   **`lib.rs`**: Tauriアプリケーションのメインロジックを実装するファイルです。
        -   **`main.rs`**: Tauriアプリケーションのエントリーポイントとなるファイルです。
    -   **`tauri.conf.json`**: Tauriアプリケーションの設定を定義するJSONファイルです。
-   **`tsconfig.json`**: TypeScriptのコンパイラ設定を定義するJSONファイルです。
-   **`tsconfig.node.json`**: Node.js環境で使用するTypeScriptコンパイラの設定を定義するJSONファイルです。
-   **`vite.config.ts`**: Viteのビルド設定を定義するTypeScriptファイルです。

### 3.3 ファイル構造の意図
このファイル構造は、Tauriフレームワークに基づいた構成で、フロントエンド（React/TypeScript）とバックエンド（Rust）のコードを分離しています。これにより、UIとビジネスロジックを明確に区別し、保守性と拡張性を高めることを意図しています。また、モジュールごとにファイルを分割することで、可読性を向上させています。

## 4. 各ファイル・モジュールの詳細

### 4.1 `src/components/drug.tsx`

- **目的**: ファイルドロップイベントを処理し、ExcelファイルのパスをRustのバックエンドに送信してCSV形式に変換する機能を提供します。
- **主要な関数/クラス**:
    -   **`GetPaths()`**: メインのコンポーネントであり、ファイルのドロップ、ファイルリストの表示、変換処理、保存処理を行います。
        -   `isLoading` state: 処理中のローディング表示を管理します。
        -   `filePaths` state: ドロップされたファイルのパスを保持します。
        -   `result` state: Rustからのレスポンス（CSVデータ）を保持します。
        -   **`invokeTauri()`**: Rustの`command_parse_excel` コマンドを呼び出し、ファイルの変換を行います。
        -   **`useEffect()`**: ファイルドロップイベントのリッスンをセットアップします。
        -   **`up(index)`**: ファイルリストの指定されたインデックスのファイルを上に移動します。
        -   **`down(index)`**: ファイルリストの指定されたインデックスのファイルを下に移動します。
        -   **`del(index)`**: ファイルリストの指定されたインデックスのファイルを削除します。
        -   **`onSave()`**:  CSVデータを `result.csv` としてダウンロードさせます。
- **依存関係**:
    -   `@tauri-apps/api`: TauriのAPIを使用します。
    -   `antd`: UIコンポーネントライブラリを使用します。
- **ポイント**:
    -   ファイルドロップイベントをリッスンして、ファイルを複数選択することができます。
    -   変換処理には、Rust側の `command_parse_excel` 関数を使用します。
    -   変換されたCSVデータは、stateで管理してUIに表示されます。
    -   変換されたCSVデータは、ローカルに保存できます。

### 4.2 `src/components/get_string.tsx`

-   **目的**: 文字列入力を受け取り、Rustのバックエンドに送信するサンプルコンポーネントです。現在、このコンポーネントはアプリの機能としては使用されていません。
-   **主要な関数/クラス**:
    -   **`GetString()`**: 文字列入力と送信ボタンを持つコンポーネントです。
        -   `str` state: 入力された文字列を保持します。
        -   **`onClick()`**: Rustの `command_get_string` コマンドを呼び出し、入力された文字列を送信します。
-   **依存関係**:
    -   `antd`: UIコンポーネントライブラリを使用します。
    -   `@tauri-apps/api`: TauriのAPIを使用します。
-   **ポイント**:
    -   Rust側との連携をデモンストレーションするためのサンプルコードです。
    -   現在はメインのアプリケーションロジックからは使用されていません。

### 4.3 `src-tauri/src/lib.rs`

-   **目的**: Tauriアプリケーションのメインロジックを実装します。
-   **主要な関数/クラス**:
    -   **`command_parse_excel(paths: Vec<String>)`**: フロントエンドからファイルパスを受け取り、Excelファイルを解析してCSV形式の文字列を返すコマンドです。
        -   引数: `paths` (ドロップされたファイルのパスの配列)
        -   返り値: 変換されたCSV形式の文字列、またはエラーメッセージ
        -   内部処理: ファイルの存在確認、拡張子の検証、Excelファイルの読み込み、データのCSV変換を行う。
-   **依存関係**:
    -   `calamine`: Excelファイル(.xlsx)を読み込むためのライブラリです。
    -   `tauri`: Tauri フレームワークを使用します。
    -   `tauri-plugin-opener`: Tauriでファイルを開く機能を提供するプラグインを使用します。
-   **ポイント**:
    -   Tauriのコマンドとして公開され、フロントエンドから呼び出されます。
    -   Excelファイルの解析とCSVへの変換処理を実装しています。
    -   エラーハンドリングを行い、フロントエンドにエラーメッセージを返します。

### 4.4 `src-tauri/src/documents/docx.rs`

-   **目的**: DOCXファイルからテキストコンテンツを抽出する機能を提供します。
-   **主要な関数/クラス**:
    -   **`read(path: &Path) -> Result<String, String>`**: 指定されたパスのDOCXファイルを読み込み、テキストコンテンツを抽出して返します。
        -   引数: `path` (DOCXファイルのパス)
        -   返り値: 抽出されたテキストコンテンツ、またはエラーメッセージ
        -   内部処理: ZIPアーカイブとしてDOCXファイルを開き、`word/document.xml` 内のテキストデータをQuick-XMLで解析して抽出します。
-  **依存関係**:
    - `quick_xml`: XMLデータを高速に解析するためのライブラリ
    - `zip`: ZIPアーカイブファイルを扱うためのライブラリ
-   **ポイント**:
    -   DOCXファイルの構造を理解し、必要なテキストデータだけを抽出します。
    -   エラー処理を行い、ファイルの読み込みや解析に失敗した場合にエラーメッセージを返します。

### 4.5  `src-tauri/src/documents/scan.rs`

-   **目的**: 指定されたディレクトリ内のファイルをスキャンし、ファイルの内容を文字列として取得する機能を提供します。この機能は、特定の拡張子を持つファイルを抽出し、その内容を文字列として取得します。
-   **主要な関数/クラス**:
    -  **`files(dir: &Path) -> Vec<String>`**: 指定されたディレクトリ内をスキャンし、指定された拡張子のファイルの内容を文字列として取得します。
        -  引数: `dir` (スキャンするディレクトリのパス)
        -  返り値: ファイルパスと内容をフォーマットした文字列のベクター
        -  内部処理: `ignore::WalkBuilder` を使用してディレクトリを再帰的にスキャンし、特定の拡張子を持つファイルのテキストコンテンツを取得します。
-   **依存関係**:
    -   `ignore`: ファイルパスを再帰的に走査するためのライブラリ。
    -   `fs`: ファイルシステム操作を行うためのライブラリ。
    - `std::path`: パスを扱うためのライブラリ
-   **ポイント**:
    - 指定されたディレクトリ以下のファイルを走査し、その内容を文字列として読み込みます。
    - 読み込むファイルは、拡張子でフィルタリングされます。
    - 現状は、この機能は使われていません。
    - `is_document_or_source_code` 関数で、拡張子によるフィルタリングを行なっています。

### 4.6 `src-tauri/src/documents/request.rs`
-  **目的**: Google Gemini API を利用してテキスト生成を行う機能を提供します。
- **主要な関数/クラス**:
    - **`get_content(v: &Value) -> Result<String, String>`**: Gemini APIからのレスポンスからテキストコンテンツを抽出します。
    - **`request(model: &str, body: Value) -> Result<Value, String>`**: 指定されたモデルとリクエストボディでGemini APIを呼び出します。
        - 引数:
           - `model`: Gemini APIのモデル名
           - `body`: リクエストボディ
        - 返り値:
          - APIからのレスポンスのJSONオブジェクト、またはエラーメッセージ
        - 内部処理:
           - 環境変数からAPIキーを取得し、APIのエンドポイントURLを生成します。
           - `reqwest` クライアントを使用してAPIリクエストを送信し、レスポンスを返します。
- **依存関係**:
    -   `reqwest`: HTTPリクエストを送信するためのライブラリです。
    -   `serde_json`: JSONデータを扱うためのライブラリです。
    -   `std::env`: 環境変数にアクセスするためのライブラリです。
-   **ポイント**:
    - 環境変数から API キーを取得します。
    - Gemini API との通信に必要な処理を抽象化しています。
    - 現在は使用していません。

### 4.7 その他ファイル

-   **`src/App.css`**: アプリケーション全体のスタイルを定義します。
-   **`src/App.tsx`**: アプリケーションのメインコンポーネントです。
-   **`src/main.tsx`**: React アプリケーションのエントリーポイントです。
-   **`src/vite-env.d.ts`**: TypeScript 環境設定ファイルです。
-   **`src-tauri/build.rs`**: Tauri アプリケーションのビルド設定です。
-   **`src-tauri/capabilities/default.json`**: アプリケーションの権限設定です。
-   **`src-tauri/Cargo.toml`**: Rust プロジェクトの設定ファイルです。
-   **`src-tauri/public/prompt.txt`**: Gemini APIで使用するプロンプトのテキストファイルです。
-   **`src-tauri/src/main.rs`**: Rust アプリケーションのエントリーポイントです。
-   **`src-tauri/tauri.conf.json`**: Tauri アプリケーションの設定ファイルです。
-   **`tsconfig.json`**: TypeScript のコンパイラ設定ファイルです。
-   **`tsconfig.node.json`**: TypeScript で Node.js 環境の設定を行うためのファイルです。
-   **`vite.config.ts`**: Vite の設定ファイルです。

## 5. 設計アルゴリズムやパターン

### 5.1 イベント駆動型アーキテクチャ

このプロジェクトでは、主にイベント駆動型アーキテクチャを採用しています。

-   **Tauriイベント**:
    -   ファイルドロップイベント (`tauri://drag-drop`): フロントエンドでファイルをドロップすると、Tauri がこのイベントを発生させます。
    -   カスタムイベント： 必要に応じて、Rust側からカスタムイベントを発行し、フロントエンドで処理することも可能です。
-   **Reactコンポーネントのステート**:
    -   UIの状態管理には、ReactのuseStateフックを利用しています。例えば、ドロップされたファイルのパスは`filePaths` state で管理され、バックエンドからのレスポンスは `result` state で管理されます。
    -   UIの更新は、これらのステートの変化に応じてReactが自動的に再レンダリングを行います。

### 5.2 非同期処理

-   **`async/await`**:
    -   Rust側で時間のかかるファイル処理（Excelの解析）を行うために、`async/await` を使用しています。これにより、UIのフリーズを防ぎ、スムーズな操作体験を提供します。
    -   フロントエンド側でも、Tauriのコマンド呼び出しには `async/await` を使用しています。

### 5.3 なぜこの設計を採用したのか
-   **イベント駆動型**:
    -   非同期的なイベントの処理（ファイルのドロップなど）に適しています。
    -   UIとバックエンドの処理を疎結合に保ち、モジュール間の独立性を高めます。
-   **`async/await`**:
    -   非同期処理を直感的に記述でき、コードの可読性を向上させます。
    -   UIスレッドをブロックせず、スムーズなユーザーエクスペリエンスを提供します。
-   **Reactのステート管理**:
    -   UIの状態を効率的に管理し、変化があった際に自動的に再レンダリングを行うため、Reactの特性を最大限に活かすことができます。

## 6. 環境構築・セットアップ手順

### 6.1 必要な依存関係のインストール

1. Node.js がインストールされていることを確認してください。（推奨バージョン：18以上）
2.  プロジェクトディレクトリに移動します。

    ```bash
    cd [プロジェクトディレクトリ]
    ```

3.  依存関係をインストールします。

    ```bash
    npm install
    ```

4.  Rustの開発環境をインストールします。

    [https://www.rust-lang.org/tools/install](https://www.rust-lang.org/tools/install)

### 6.2 環境変数の設定
APIキーなどの機密情報は環境変数として設定してください。
- 例:
    ```bash
    export GOOGLE_GEMINI_API_KEY="your_api_key"
    ```
-  `.env` ファイルを使用することも可能です。
    ```env
    GOOGLE_GEMINI_API_KEY="your_api_key"
    ```

### 6.3 開発環境における問題と解決策
- **問題**: Node.jsモジュールのインストール時にエラーが発生する。
    - **解決策**:
        1.  Node.jsとnpmのバージョンが要件を満たしているか確認してください。
        2.  `package.json` に記述された依存関係が正しいか確認してください。
        3.  `npm cache clean --force` でキャッシュをクリアしてみてください。
        4.  `node_modules` ディレクトリを削除し、再度 `npm install` を実行してみてください。
- **問題**: Tauriの環境設定が正しく行えない。
    - **解決策**:
        1.  Tauriの公式サイトのインストール手順を確認し、不足している依存関係がないか確認してください。
        2.  Rustの開発環境が正しくインストールされているか確認してください。
        3.  Tauri CLIが正しくインストールされているか確認してください。

## 7. ベストプラクティスと拡張方法

### 7.1 ベストプラクティス

-   **可読性**: コードの可読性を高めるため、適切な命名規則を適用し、コメントを記述しましょう。
-   **テスト**: 単体テストを記述し、コードの品質と信頼性を確保しましょう。
-   **機密情報**: APIキーなどの機密情報は環境変数で管理し、コードに直接記述しないようにしましょう。
-   **エラーハンドリング**: エラーハンドリングを適切に行い、予期しないエラーが発生した場合でもアプリがクラッシュしないようにしましょう。
-   **コードレビュー**: 定期的にコードレビューを行い、コードの品質を向上させましょう。

### 7.2 プロジェクトの拡張方法

-   **新しい機能**: 新しい機能を開発する際には、既存のイベント駆動型アーキテクチャを尊重し、コードの一貫性を保ちましょう。
-   **UIコンポーネント**: UIコンポーネントは再利用可能になるように設計し、モジュール化しましょう。
-   **API連携**: API連携を行う際には、`reqwest` などのライブラリを利用して非同期的に処理を行い、UIをブロックしないように注意しましょう。
-   **データベース**: データベースを利用する場合は、ORM(Object Relational Mapper) を検討し、SQLインジェクションなどのセキュリティ脆弱性に対する対策を行いましょう。
-   **国際化**: 多言語対応が必要な場合は、国際化ライブラリを導入して、簡単に多言語対応できるようにしましょう。
-   **CI/CD**: 継続的インテグレーション (CI) を導入し、自動テストとデプロイを自動化しましょう。
-   **パフォーマンス**: パフォーマンスボトルネックを特定し、必要に応じて最適化を行いましょう。

### 7.3 新規参加者向け追記

-   **依存ライブラリ**: このプロジェクトでは、以下の主要なライブラリを使用しています。
    -   `@tauri-apps/api`: TauriフレームワークのAPIを使用します。
    -   `antd`: UIコンポーネントライブラリを提供します。
    -   `calamine`: Excelファイルを読み込むためのライブラリです。
    -    `reqwest` HTTPクライアントライブラリ
    - `quick_xml`: XMLデータを高速に解析するためのライブラリ
    - `zip`: ZIPアーカイブファイルを扱うためのライブラリ

-   **動作上の特殊な要件**: アプリケーションの動作には、`node.js(version>=18)`, `npm`, `Rust` の開発環境が必要です。また、`GOOGLE_GEMINI_API_KEY` 環境変数を設定する必要があります。
-   **推奨される使用ケース**: `src/components/drug.tsx` は、ユーザーがExcelファイルをドロップし、CSVデータに変換する際に使用されます。

---

上記ドキュメントは、提供されたファイルに基づいて作成されました。具体的な実装の詳細や、未実装機能については、適宜修正してください。
